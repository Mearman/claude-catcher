#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$(perl -MCwd -e 'print Cwd::realpath($ARGV[0])' "$0")")" && pwd)"
source "$SCRIPT_DIR/../lib/lib.sh"

cmd_ps() {
  local pids
  pids=$(find_strays)

  if [ -z "$pids" ]; then
    echo "No stray Claude processes found."
    exit 0
  fi

  echo "$(count_strays "$pids") stray Claude process(es):"
  show_strays "$pids"
}

cmd_kill() {
  local pids
  pids=$(find_strays)

  if [ -z "$pids" ]; then
    echo "No stray Claude processes found."
    exit 0
  fi

  local count
  count=$(count_strays "$pids")
  echo "Found $count stray Claude process(es):"
  show_strays "$pids"
  echo ""

  if [ "$1" = "-f" ]; then
    echo "Force killing (SIGKILL)..."
    kill -9 $pids
  else
    kill_strays "$pids"
    if [ $? -eq 1 ]; then
      echo "Force killed $count stray(s)."
    else
      echo "Killed $count stray(s)."
    fi
  fi
}

cmd_monitor() {
  local LOG_DIR="$HOME/.local/log"
  local LOG_FILE="$LOG_DIR/claude-catcher.log"
  local KILL=false NOTIFY=false QUIET=false

  for arg in "$@"; do
    case "$arg" in
      --kill)   KILL=true ;;
      --notify) NOTIFY=true ;;
      --quiet)  QUIET=true ;;
    esac
  done

  mkdir -p "$LOG_DIR"

  local ts
  ts=$(date +"%Y-%m-%d %H:%M:%S")
  local pids
  pids=$(find_strays)

  if [ -z "$pids" ]; then
    [ "$QUIET" = false ] && echo "$ts No stray Claude processes." >> "$LOG_FILE"
    exit 0
  fi

  local count details
  count=$(count_strays "$pids")
  details=$(show_strays "$pids")

  echo "$ts Found $count stray Claude process(es):" >> "$LOG_FILE"
  echo "$details" >> "$LOG_FILE"

  if [ "$NOTIFY" = true ]; then
    osascript -e "display notification \"$count stray Claude process(es) detected\" with title \"claude-catcher\""
  fi

  if [ "$KILL" = true ]; then
    kill_strays "$pids"
    if [ $? -eq 1 ]; then
      echo "$ts Force killed $count stray(s)." >> "$LOG_FILE"
    else
      echo "$ts Killed $count stray(s)." >> "$LOG_FILE"
    fi
  fi
}

cmd_config() {
  local BIN_DIR
  BIN_DIR="$SCRIPT_DIR"
  local CATCHER="$BIN_DIR/claude-catcher"
  local current
  current=$(crontab -l 2>/dev/null | grep "claude-catcher monitor" || true)

  if [ -n "$current" ]; then
    echo "Current cron entry:"
    echo "  $current"
  else
    echo "No cron job configured."
  fi
  echo ""

  # On/off
  read -p "Enable cron job? [y/N] " enable
  if [[ ! "$enable" =~ ^[Yy]$ ]]; then
    if [ -n "$current" ]; then
      crontab -l 2>/dev/null | grep -v "claude-catcher monitor" | crontab -
      echo "Cron job removed."
    fi
    return
  fi

  # Interval
  echo ""
  echo "Interval:"
  echo "  1) Every 1 minute"
  echo "  2) Every 5 minutes (default)"
  echo "  3) Every 15 minutes"
  echo "  4) Every 30 minutes"
  read -p "Choose [1-4]: " interval_choice
  case "$interval_choice" in
    1) schedule="* * * * *" ;;
    3) schedule="*/15 * * * *" ;;
    4) schedule="*/30 * * * *" ;;
    *) schedule="*/5 * * * *" ;;
  esac

  # Flags
  local flags=""
  echo ""
  read -p "Auto-kill strays? [Y/n] " kill_choice
  [[ ! "$kill_choice" =~ ^[Nn]$ ]] && flags="$flags --kill"

  read -p "Send macOS notifications? [Y/n] " notify_choice
  [[ ! "$notify_choice" =~ ^[Nn]$ ]] && flags="$flags --notify"

  read -p "Suppress 'no strays' log entries? [Y/n] " quiet_choice
  [[ ! "$quiet_choice" =~ ^[Nn]$ ]] && flags="$flags --quiet"

  local cron_cmd="$CATCHER monitor$flags"

  # Install
  (crontab -l 2>/dev/null | grep -v "claude-catcher monitor"; echo "$schedule $cron_cmd") | crontab -
  echo ""
  echo "Cron installed: $schedule $cron_cmd"
}

cmd_install() {
  local BIN_DIR="$HOME/.local/bin"
  mkdir -p "$BIN_DIR"

  for cmd in claude-catcher stray-claude hang-claude; do
    ln -sf "$CLAUDE_CATCHER_ROOT/bin/$cmd" "$BIN_DIR/$cmd"
    echo "  $BIN_DIR/$cmd → $CLAUDE_CATCHER_ROOT/bin/$cmd"
  done

  if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
    echo ""
    echo "WARNING: $BIN_DIR is not on your PATH."
    echo "Add this to your shell config:"
    echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
  fi

  echo ""
  cmd_config
}

cmd_update() {
  if [ ! -d "$CLAUDE_CATCHER_ROOT/.git" ]; then
    echo "Error: $CLAUDE_CATCHER_ROOT is not a git repository." >&2
    exit 1
  fi
  cd "$CLAUDE_CATCHER_ROOT" || { echo "Error: cannot cd to $CLAUDE_CATCHER_ROOT" >&2; exit 1; }
  if git pull --ff-only; then
    echo "Updated."
  else
    echo "Update failed. You may have local changes or a diverged branch." >&2
    exit 1
  fi
}

cmd_help() {
  cat <<'EOF'
Usage: claude-catcher <command> [options]

Commands:
  ps, ls          List stray Claude processes
  kill [-f]       Kill strays (SIGTERM, then SIGKILL). -f for immediate SIGKILL
  monitor         Cron-friendly monitor (--kill --notify --quiet)
  config          Configure the cron job (interval, flags)
  install         Symlink commands to ~/.local/bin and configure cron
  update          Pull latest from git
  help            Show this help

Aliases:
  stray-claude    → claude-catcher ps
  hang-claude     → claude-catcher kill
EOF
}

# Resolve command from argv or invocation name
cmd="${1:-help}"
invocation="$(basename "$0")"

case "$invocation" in
  stray-claude) cmd="ps" ;;
  hang-claude)  cmd="kill" ;;
esac

case "$invocation" in
  stray-claude|hang-claude) shift 0 2>/dev/null ;;
  *) shift 1 2>/dev/null ;;
esac

case "$cmd" in
  ps|ls)    cmd_ps "$@" ;;
  kill)     cmd_kill "$@" ;;
  monitor)  cmd_monitor "$@" ;;
  config)   cmd_config ;;
  install)  cmd_install ;;
  update)   cmd_update ;;
  help|-h|--help) cmd_help ;;
  *)        echo "Unknown command: $cmd"; cmd_help; exit 1 ;;
esac
