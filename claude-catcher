#!/bin/bash

# --- core ---

_realpath() { perl -MCwd -e 'print Cwd::realpath($ARGV[0])' "$1"; }

CLAUDE_CATCHER_ROOT="$(cd "$(dirname "$(_realpath "$0")")" && pwd)"

BIN_DIR="$HOME/.local/bin"
CRON_PATTERN="claude-catcher monitor"

find_strays() {
  ps -eo pid,state,tty,comm | awk '$3 == "??" && $4 == "claude" && $2 == "R" {print $1}'
}

count_strays() {
  local pids="$1"
  if [ -z "$pids" ]; then echo 0; return; fi
  echo "$pids" | wc -l | tr -d ' '
}

show_strays() {
  local pids="$1"
  ps -o pid,%cpu,etime,state,command -p "$(echo "$pids" | tr '\n' ',')" 2>/dev/null
}

# Find strays or exit. Sets STRAY_PIDS and STRAY_COUNT.
require_strays() {
  STRAY_PIDS=$(find_strays)
  if [ -z "$STRAY_PIDS" ]; then
    echo "No stray Claude processes found."
    exit 0
  fi
  STRAY_COUNT=$(count_strays "$STRAY_PIDS")
}

kill_strays() {
  local pids="$1"
  echo "$pids" | xargs kill 2>/dev/null
  sleep 2
  local survivors=""
  local pid
  for pid in $pids; do
    if ps -p "$pid" -o pid= &>/dev/null; then
      survivors="$survivors $pid"
    fi
  done
  if [ -n "$survivors" ]; then
    echo "$survivors" | xargs kill -9 2>/dev/null
    return 1 # needed force kill
  fi
  return 0 # clean kill
}

# --- commands ---

cmd_ps() {
  require_strays
  echo "$STRAY_COUNT stray Claude process(es):"
  show_strays "$STRAY_PIDS"
}

cmd_kill() {
  require_strays
  echo "Found $STRAY_COUNT stray Claude process(es):"
  show_strays "$STRAY_PIDS"
  echo ""

  if [ "$1" = "-f" ]; then
    echo "Force killing (SIGKILL)..."
    echo "$STRAY_PIDS" | xargs kill -9
  else
    kill_strays "$STRAY_PIDS"
    if [ $? -eq 1 ]; then
      echo "Force killed $STRAY_COUNT stray(s)."
    else
      echo "Killed $STRAY_COUNT stray(s)."
    fi
  fi
}

cmd_monitor() {
  local LOCK_DIR="/tmp/claude-catcher.lock"
  if ! mkdir "$LOCK_DIR" 2>/dev/null; then
    # Remove stale lock older than 5 minutes
    if [ -d "$LOCK_DIR" ] && find "$LOCK_DIR" -maxdepth 0 -mmin +5 -print -quit | grep -q .; then
      rmdir "$LOCK_DIR" 2>/dev/null
      mkdir "$LOCK_DIR" 2>/dev/null || exit 0
    else
      exit 0  # another instance is running
    fi
  fi
  trap 'rmdir "$LOCK_DIR" 2>/dev/null' EXIT

  local LOG_DIR="$HOME/.local/log"
  local LOG_FILE="$LOG_DIR/claude-catcher.log"
  local KILL=false NOTIFY=false QUIET=false

  for arg in "$@"; do
    case "$arg" in
      --kill)   KILL=true ;;
      --notify) NOTIFY=true ;;
      --quiet)  QUIET=true ;;
    esac
  done

  mkdir -p "$LOG_DIR" || { echo "Error: cannot create $LOG_DIR" >&2; exit 1; }

  local ts
  ts=$(date +"%Y-%m-%d %H:%M:%S")
  local pids
  pids=$(find_strays)

  if [ -z "$pids" ]; then
    [ "$QUIET" = false ] && echo "$ts No stray Claude processes." >> "$LOG_FILE"
    exit 0
  fi

  local count details
  count=$(count_strays "$pids")
  details=$(show_strays "$pids")

  echo "$ts Found $count stray Claude process(es):" >> "$LOG_FILE"
  echo "$details" >> "$LOG_FILE"

  if [ "$NOTIFY" = true ]; then
    osascript -e "display notification \"$count stray Claude process(es) detected\" with title \"claude-catcher\""
  fi

  if [ "$KILL" = true ]; then
    kill_strays "$pids"
    if [ $? -eq 1 ]; then
      echo "$ts Force killed $count stray(s)." >> "$LOG_FILE"
    else
      echo "$ts Killed $count stray(s)." >> "$LOG_FILE"
    fi
  fi
}

cmd_config() {
  local CATCHER="$BIN_DIR/claude-catcher"
  local current
  current=$(crontab -l 2>/dev/null | grep "$CRON_PATTERN" || true)

  if [ -n "$current" ]; then
    echo "Current cron entry:"
    echo "  $current"
  else
    echo "No cron job configured."
  fi
  echo ""

  # On/off
  read -p "Enable cron job? [y/N] " enable
  if [[ ! "$enable" =~ ^[Yy]$ ]]; then
    if [ -n "$current" ]; then
      crontab -l 2>/dev/null | grep -v "$CRON_PATTERN" | crontab -
      echo "Cron job removed."
    fi
    return
  fi

  # Interval
  echo ""
  echo "Interval:"
  echo "  1) Every 1 minute"
  echo "  2) Every 5 minutes (default)"
  echo "  3) Every 15 minutes"
  echo "  4) Every 30 minutes"
  read -p "Choose [1-4]: " interval_choice
  case "$interval_choice" in
    1) schedule="* * * * *" ;;
    2) schedule="*/5 * * * *" ;;
    3) schedule="*/15 * * * *" ;;
    4) schedule="*/30 * * * *" ;;
    *) echo "  Invalid choice, using default (every 5 minutes)."; schedule="*/5 * * * *" ;;
  esac

  # Flags
  local flags=""
  echo ""
  read -p "Auto-kill strays? [Y/n] " kill_choice
  [[ ! "$kill_choice" =~ ^[Nn]$ ]] && flags="$flags --kill"

  read -p "Send macOS notifications? [Y/n] " notify_choice
  [[ ! "$notify_choice" =~ ^[Nn]$ ]] && flags="$flags --notify"

  read -p "Suppress 'no strays' log entries? [Y/n] " quiet_choice
  [[ ! "$quiet_choice" =~ ^[Nn]$ ]] && flags="$flags --quiet"

  local cron_cmd="$CATCHER monitor$flags"

  # Install
  (crontab -l 2>/dev/null | grep -v "$CRON_PATTERN"; echo "$schedule $cron_cmd") | crontab -
  echo ""
  echo "Cron installed: $schedule $cron_cmd"
}

cmd_install() {
  mkdir -p "$BIN_DIR" || { echo "Error: cannot create $BIN_DIR" >&2; exit 1; }

  ln -sf "$CLAUDE_CATCHER_ROOT/claude-catcher" "$BIN_DIR/claude-catcher"
  echo "  $BIN_DIR/claude-catcher → $CLAUDE_CATCHER_ROOT/claude-catcher"

  for cmd in stray-claude hang-claude; do
    ln -sf "$CLAUDE_CATCHER_ROOT/.claude-catcher.d/$cmd" "$BIN_DIR/$cmd"
    echo "  $BIN_DIR/$cmd → $CLAUDE_CATCHER_ROOT/.claude-catcher.d/$cmd"
  done

  if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
    echo ""
    echo "WARNING: $BIN_DIR is not on your PATH."
    echo "Add this to your shell config:"
    echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
  fi

  echo ""
  cmd_config
}

cmd_uninstall() {
  for cmd in claude-catcher stray-claude hang-claude; do
    if [ -L "$BIN_DIR/$cmd" ]; then
      rm "$BIN_DIR/$cmd"
      echo "  Removed $BIN_DIR/$cmd"
    fi
  done

  if crontab -l 2>/dev/null | grep -q "$CRON_PATTERN"; then
    crontab -l 2>/dev/null | grep -v "$CRON_PATTERN" | crontab -
    echo "  Removed cron entry"
  fi

  echo ""
  echo "Done. Log file at ~/.local/log/claude-catcher.log was left in place."
}

cmd_update() {
  if [ ! -d "$CLAUDE_CATCHER_ROOT/.git" ]; then
    echo "Error: $CLAUDE_CATCHER_ROOT is not a git repository." >&2
    exit 1
  fi
  cd "$CLAUDE_CATCHER_ROOT" || { echo "Error: cannot cd to $CLAUDE_CATCHER_ROOT" >&2; exit 1; }
  if git pull --ff-only; then
    echo "Updated."
  else
    echo "Update failed. You may have local changes or a diverged branch." >&2
    exit 1
  fi
}

cmd_help() {
  cat <<'EOF'
Usage: claude-catcher <command> [options]

Commands:
  ps, ls          List stray Claude processes
  kill [-f]       Kill strays (SIGTERM, then SIGKILL). -f for immediate SIGKILL
  monitor         Cron-friendly monitor (--kill --notify --quiet)
  config          Configure the cron job (interval, flags)
  install         Symlink commands to ~/.local/bin and configure cron
  uninstall       Remove symlinks and cron entry
  update          Pull latest from git
  help            Show this help

Aliases:
  stray-claude    → claude-catcher ps
  hang-claude     → claude-catcher kill
EOF
}

# --- dispatch ---

cmd="${1:-help}"
shift 1 2>/dev/null || true

case "$cmd" in
  ps|ls)    cmd_ps "$@" ;;
  kill)     cmd_kill "$@" ;;
  monitor)  cmd_monitor "$@" ;;
  config)   cmd_config ;;
  install)  cmd_install ;;
  uninstall) cmd_uninstall ;;
  update)   cmd_update ;;
  help|-h|--help) cmd_help ;;
  *)        echo "Unknown command: $cmd"; cmd_help; exit 1 ;;
esac
